<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MR Store</title>
<style>
:root{--bg:#0b0f1a;--card:#111726;--accent:#4da3ff;--gold:#ffd700;--note:#ffcc00;--muted:#99a3b3;--success:#00d4aa;--error:#ff4444;--warning:#ff9800}
body{margin:0;font-family:"Tajawal",sans-serif;background:var(--bg);color:#fff}
header{background:var(--card);padding:18px;text-align:center;font-size:22px;color:var(--accent);font-weight:700;position:relative;display:flex;justify-content:space-between;align-items:center}

/* Ø²Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± */
#headerAuthBtn{background:linear-gradient(180deg,#0ff3d0,#00b2ff);color:#051020;border-radius:10px;padding:10px 16px;font-weight:800;cursor:pointer;border:none;margin-left:10px}
#headerAuthBtn:hover{transform:translateY(-2px)}

/* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± */
#headerUserMenu{display:flex;gap:8px;align-items:center}
#headerUserAvatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#ffd700,#ffb84d);display:flex;align-items:center;justify-content:center;color:#081220;font-weight:900;cursor:pointer;overflow:hidden;object-fit:cover}
#headerUserAvatarFallback{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#ffd700,#ffb84d);display:flex;align-items:center;justify-content:center;color:#081220;font-weight:900;cursor:pointer}
#headerUserName{background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:10px;color:var(--accent);font-weight:800;cursor:pointer}

nav{background:#131a2c;display:flex;justify-content:center;gap:8px;padding:8px;flex-wrap:wrap}
nav a{color:var(--accent);text-decoration:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
nav a:hover{background:#0f1724}
nav a.active{background:var(--accent);color:#081220}

.container{max-width:820px;margin:22px auto;background:var(--card);padding:20px;border-radius:12px;border:1px solid #4da3ff33;box-sizing:border-box}

label{display:block;margin-top:12px;font-weight:700;text-align:right}

select,input,textarea{
  width:100%;
  padding:10px;
  margin-top:6px;
  border-radius:12px;
  border:none;
  background:#0f1724;
  color:#fff;
  box-sizing:border-box;
  outline:none;
  box-shadow:0 0 12px rgba(0,255,200,0.55);
  transition:0.25s;
}

select:focus,input:focus,textarea:focus{
  box-shadow:0 0 18px rgba(0,255,200,0.85);
}

select[multiple]{height:150px}

.row{display:flex;gap:12px;align-items:center}
.small{width:48%}

button{
  padding:12px;
  background:var(--accent);
  color:#081220;
  border:none;
  border-radius:10px;
  font-weight:800;
  cursor:pointer;
  margin-top:12px;
  transition:0.2s;
}

button:hover{transform:scale(1.02)}
button.full-width{width:100%}

.discount-btn{
  background:#00d4aa;
  color:#000;
  font-weight:900;
  border-radius:10px;
  padding:10px;
}

.discount-btn.used{
  background:#444;
  color:#999;
  cursor:default;
}

.total{color:var(--gold);font-weight:900;margin-top:8px}

.note{
  background:#0e1724;
  padding:10px;
  border-radius:8px;
  color:var(--note);
  text-align:center;
  margin-top:12px
}

.footer{padding:16px;text-align:center;color:#bbb;margin-top:18px}

/* success popup */
.success-popup{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  z-index:9999;
  justify-content:center;
  align-items:center
}

.popup-card{
  background:var(--card);
  padding:22px;
  border-radius:14px;
  text-align:center;
  border:1px solid #4da3ff33;
  max-width:420px
}

.crown{
  font-size:56px;
  color:var(--gold);
  text-shadow:0 0 14px #ffec99;
  margin-bottom:6px
}

.popup-card h2{
  color:#00ffcc;
  margin:8px 0
}

/* auth modal */
.modal-backdrop{display:none;position:fixed;inset:0;background:rgba(1,6,12,0.6);z-index:10001;justify-content:center;align-items:center}
.modal{background:var(--card);padding:18px;border-radius:12px;width:360px;max-width:92%;border:1px solid #4da3ff33}
.modal h3{margin:0 0 12px;color:#00ffcc}
.form-row{margin-bottom:8px;text-align:right}
.small-note{font-size:13px;color:var(--muted);margin-top:6px}

/* dropdown menu */
.user-dropdown{display:none;position:absolute;top:60px;right:14px;background:var(--card);border:1px solid #4da3ff33;padding:8px;border-radius:10px;min-width:160px;box-shadow:0 8px 30px rgba(0,0,0,0.6);z-index:10000}
.user-dropdown button{width:100%;text-align:right;padding:8px;background:transparent;color:#fff;border:none;cursor:pointer;border-radius:8px}
.user-dropdown button:hover{background:#0f1724}

/* profile page */
#profilePanel{display:none;position:fixed;inset:0;background:rgba(2,6,12,0.97);z-index:10002;padding:18px;overflow:auto;border:none}
.profile-header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:20px}
.profile-box{background:var(--card);padding:15px;border-radius:10px;border:1px solid #4da3ff33;margin-top:12px}
.order-item{background:#0e1724;padding:10px;border-radius:8px;margin-top:8px;border:1px solid rgba(255,255,255,0.03)}

/* Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ */
.back-btn{background:transparent;color:var(--accent);border:1px solid var(--accent);padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:700;display:flex;align-items:center;gap:8px}
.back-btn:hover{background:rgba(77,163,255,0.1)}

/* Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© */
.upload-btn{background:#ffd700;color:#000;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:700;display:inline-flex;align-items:center;gap:8px}
.upload-btn:hover{background:#ffcc00}

/* Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨ */
.repeat-order-btn{background:#ffd700;color:#000;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-weight:700;font-size:12px}
.repeat-order-btn:hover{background:#ffcc00}

/* custom alerts */
.custom-alert{position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:15px 20px;border-radius:10px;z-index:100000;box-shadow:0 5px 20px rgba(0,0,0,0.3);display:flex;align-items:center;gap:12px;min-width:300px;max-width:90%;animation:slideDown 0.3s ease;border:1px solid rgba(255,255,255,0.1);font-weight:700}
.alert-success{background:#00d4aa;color:white}
.alert-error{background:#ff4444;color:white}
.alert-info{background:#4da3ff;color:white}
.alert-warning{background:#ffd700;color:black}

@keyframes slideDown{
  from{top:-100px;opacity:0}
  to{top:20px;opacity:1}
}

/* quick order history */
.quick-history{display:none;background:#131a2c;border-radius:10px;padding:15px;margin-top:15px;border:1px solid #4da3ff33}
.history-item{background:#0e1724;padding:10px;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
.history-details{flex:1;margin-right:10px}

/* loading */
.loading{display:none;text-align:center;padding:20px}
.spinner{width:40px;height:40px;border:4px solid var(--accent);border-top:4px solid transparent;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}

@keyframes spin{
  0%{transform:rotate(0deg)}
  100%{transform:rotate(360deg)}
}

/* ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
.profile-avatar-large{width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg,#ffd700,#ffb84d);display:flex;align-items:center;justify-content:center;color:#081220;font-weight:900;font-size:32px;overflow:hidden;object-fit:cover;cursor:pointer;border:3px solid var(--accent)}

/* input file Ù…Ø®ÙÙŠ */
.file-input{display:none}

/* responsive */
@media(max-width:520px){
  .row{flex-direction:column}
  .small{width:100%}
  #headerUserName{display:none}
  header{padding:12px}
  .profile-avatar-large{width:80px;height:80px;font-size:28px}
  .modal{width:92%}
}
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js"></script>
</head>
<body>

<header>
  <div>MR Store</div>
  <div>
    <!-- Ø²Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± -->
    <button id="headerAuthBtn" onclick="openAuth()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    
    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± -->
    <div id="headerUserMenu" style="display:none">
      <img id="headerUserAvatar" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù" style="display:none">
      <div id="headerUserAvatarFallback">A</div>
      <div id="headerUserName" onclick="toggleHeaderDropdown()">Ø§Ø³Ù…Ùƒ</div>
      <div id="headerDropdown" class="user-dropdown">
        <button onclick="openProfile()">ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</button>
        <button onclick="openChangePassword()">ğŸ” ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</button>
        <button onclick="logout()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>
</header>

<nav>
  <a id="navProducts" class="active" onclick="showProducts()">ğŸ›ï¸ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
  <a id="navPayment" onclick="showPayment()">ğŸ’³ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹</a>
  <a id="navCards" onclick="showCards()">ğŸ® Ø¨Ø·Ø§Ù‚Ø§Øª</a>
</nav>

<!-- ===================== Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ===================== -->
<div class="container" id="productsSection">
  <!-- ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹ -->
  <div class="quick-history" id="quickHistory">
    <h4 style="color:#ffd700;margin-top:0">ğŸ”„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h4>
    <div id="quickHistoryList"></div>
  </div>
  
  <form id="orderForm" onsubmit="return false">
    
    <label for="category">ğŸ“ Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…:</label>
    <select id="category" onchange="updateCategory()" required>
      <option value="">-- Ø§Ø®ØªØ± --</option>
      <option value="games">GAMES</option>
      <option value="psn">PSN CARDS</option>
    </select>

    <!-- Ù‚Ø³Ù… GAMES -->
    <div id="gamesSection" style="display:none;margin-top:12px">
      <label for="game">ğŸ® Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„Ø¹Ø¨Ø©:</label>
      <select id="game" onchange="updateGameOptions()">
        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù„Ø¹Ø¨Ø© --</option>
        <option value="pubg">PUBG Mobile</option>
        <option value="freefire">Free Fire</option>
        <option value="deltaforce">Delta Force Mobile</option>
        <option value="roblox">Roblox (USA)</option>
        <option value="newstate">PUBG New State</option>
      </select>

      <div id="gameAmountSection" style="display:none;margin-top:8px">
        <label>ğŸ“¦ Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø§Øª (Ø­ØªÙ‰ 3 Ø¨Ø§Ù‚Ø§Øª):</label>
        <select id="gameAmount" multiple onchange="handleSelectionLimit('game')"></select>

        <button type="button" id="gameDiscountBtn" class="discount-btn" onclick="applyDiscount('game')">
          ğŸ’° ØªÙØ¹ÙŠÙ„ Ø®ØµÙ… 1.5%
        </button>

        <div id="gameTotal" class="total">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0.00 Ø¯.Ø£</div>
      </div>
    </div>

    <!-- Ù‚Ø³Ù… PSN -->
    <div id="psnSection" style="display:none;margin-top:12px">
      <label for="psnType">ğŸ´ Ø§Ø®ØªØ± Ù†ÙˆØ¹ PSN:</label>
      <select id="psnType" onchange="updatePSNOptions()">
        <option value="">-- Ø§Ø®ØªØ± --</option>
        <option value="usa">PSN USA</option>
        <option value="sa">PSN SA</option>
      </select>

      <div id="psnAmountSection" style="display:none;margin-top:8px">
        <label>ğŸ“¦ Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø§Øª (Ø­ØªÙ‰ 3 Ø¨Ø§Ù‚Ø§Øª):</label>
        <select id="psnAmount" multiple onchange="handleSelectionLimit('psn')"></select>

        <div class="row" style="margin-top:8px">
          <div class="small">
            <label>ğŸ’° ØªÙØ¹ÙŠÙ„ Ø®ØµÙ… PSN (1.5%)</label>
            <button type="button" id="psnDiscountBtn" class="discount-btn" onclick="applyDiscount('psn')">
              ØªÙØ¹ÙŠÙ„ Ø®ØµÙ… 1.5%
            </button>
          </div>

          <div class="small">
            <label>ğŸ“¨ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</label>
            <select id="psnDelivery">
              <option value="direct">Ø´Ø­Ù† Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø­Ø³Ø§Ø¨</option>
              <option value="code">Ø§Ø³ØªÙ„Ø§Ù… ÙƒÙˆØ¯</option>
            </select>
          </div>
        </div>

        <div id="psnTotal" class="total">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0.00 Ø¯.Ø£</div>
      </div>
    </div>

    <!-- Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
    <div id="detailsSection" style="display:none;margin-top:14px">
      <label>ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… / ID:</label>
      <input id="username" placeholder="Ù…Ø«Ø§Ù„: player123" required>

      <label>ğŸ“± Ø¥Ù†Ø³ØªØºØ±Ø§Ù…:</label>
      <input id="insta" placeholder="@username" required>

      <label>ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
      <input id="email" type="email" placeholder="example@mail.com" required>

      <label>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:</label>
      <textarea id="notes" placeholder="Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ø¹Ø¨Ø± GMAIL ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ØªØ¶Ù Ø§Ù„insta"></textarea>

      <button type="button" id="sendBtn" onclick="sendOrder()" class="full-width">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>
      
      <!-- Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø£Ø®ÙŠØ± -->
      <button type="button" id="repeatLastBtn" onclick="repeatLastOrder()" class="full-width" style="background:#ffd700;color:#000;display:none;margin-top:10px">
        ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø·Ù„Ø¨ Ø¢Ø®Ø± Ø·Ù„Ø¨ÙŠØ©
      </button>

      <div class="note" style="margin-top:12px">
        ğŸ“¨ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: <b>asdm86411@gmail.com</b>
      </div>
    </div>

  </form>
</div>

<!-- ===================== Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹ ===================== -->
<div class="container" id="paymentSection" style="display:none">
  <h3 style="color:var(--gold);margin:0 0 8px">ğŸ’³ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹</h3>
  <p style="line-height:1.6;font-size:18px">
    â€¢ U Wallet<br>
    â€¢ Zain Cash<br>
    â€¢ Orange Money<br>
    â€¢ Click
  </p>

  <p style="margin-top:20px">
    Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±:
    <b id="aliasName" style="color:var(--gold);font-size:20px">MRSDFOR</b>
  </p>

  <button type="button" onclick="copyAlias()" class="full-width">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø§Ø³Ù…</button>

  <div class="note" style="margin-top:12px">
    ğŸ“ Ø¯Ø¹Ù…: <b style="color:#fff">elzw520@gmail.com</b>
  </div>

  <div class="note" style="margin-top:14px;background:#162033;color:#ffd700;padding:14px">
    ÙÙŠ Ø­Ø§Ù„ Ø¯Ø¹Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¹Ø¨Ø± Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø± ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø§Ø³Ù…ØŒ  
    ÙˆÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… Ø¯Ø¹Ù…Ù‡ ÙŠØ±Ø¬Ù‰ ÙˆØ¶Ø¹ Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ£Ù† ÙŠÙƒÙˆÙ† Ù…ØªÙˆÙØ± Ù„Ù„ØªÙˆØ§ØµÙ„  
    Ø£Ùˆ Ø­Ø³Ø§Ø¨ Instagram. Ø´ÙƒØ±Ù‹Ø§ ğŸ¤ğŸ¤
  </div>
</div>

<!-- ===================== Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ===================== -->
<div class="container" id="cardsSection" style="display:none">
  <h3 style="color:#00ffcc;text-align:center;margin:0 0 12px">ğŸ® Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</h3>
  <p style="text-align:center;font-size:18px;color:#ffd700">
    Ø³ÙŠØªÙ… ØªÙˆÙÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù‚Ø±ÙŠØ¨Ø§Ù‹ â­
  </p>
</div>

<!-- profile panel -->
<div id="profilePanel">
  <div class="profile-header">
    <div style="display:flex;gap:12px;align-items:center">
      <button class="back-btn" onclick="closeProfile()">
        â† Ø§Ù„Ø±Ø¬ÙˆØ¹
      </button>
    </div>
    <div>
      <button onclick="closeProfile()" style="width:auto;padding:8px 12px;background:#4da3ff;color:#fff;border-radius:10px;border:none;cursor:pointer">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <div style="text-align:center;margin-bottom:20px">
    <!-- ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„ÙƒØ¨ÙŠØ±Ø© -->
    <img id="profileAvatarLarge" class="profile-avatar-large" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù" style="display:none;margin:0 auto">
    <div id="profileAvatarFallback" class="profile-avatar-large" style="margin:0 auto">A</div>
    
    <!-- Ø²Ø± ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© -->
    <input type="file" id="profileImageInput" class="file-input" accept="image/*">
    <button class="upload-btn" onclick="document.getElementById('profileImageInput').click()" style="margin-top:10px">
      ğŸ“· ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©
    </button>
    <button class="upload-btn" onclick="removeProfileImage()" style="margin-top:10px;background:#ff4444;color:white">
      ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©
    </button>
  </div>

  <div class="profile-box">
    <h4>ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h4>
    <div id="profileName" style="font-size:20px;font-weight:900;color:var(--accent);margin-bottom:5px">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
    <div id="profileInsta" style="color:var(--muted);font-size:14px;margin-bottom:5px">@insta</div>
    <div id="profileEmail" style="color:var(--muted);font-size:14px">email@example.com</div>
    <div id="profileMemberSince" style="color:var(--muted);font-size:14px;margin-top:5px">Ø¹Ø¶Ùˆ Ù…Ù†Ø°: 2025-01-01</div>
  </div>

  <div class="profile-box">
    <h4>âš™ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h4>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input id="editName" placeholder="Ø§Ù„Ø§Ø³Ù…" style="width:45%"/>
      <input id="editInsta" placeholder="@instagram" style="width:45%"/>
    </div>
    <button onclick="saveProfile()" style="margin-top:10px;width:100%">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
    <button onclick="openChangePassword()" style="margin-top:10px;width:100%;background:#ffd700;color:#000">ğŸ” ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</button>
  </div>

  <div class="profile-box">
    <h4>ğŸ“‹ Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h4>
    <div id="ordersList">
      <p style="color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</p>
    </div>
  </div>

</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
<div id="passwordResetModal" class="modal-backdrop" style="display:none">
  <div class="modal">
    <h3 style="color:#ffd700">ğŸ”“ Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
    <p>Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆØ³Ù†Ø±Ø³Ù„ Ù„Ùƒ Ø±Ø§Ø¨Ø·Ù‹Ø§ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</p>
    <input type="email" id="forgotEmail" placeholder="Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" style="width:100%;padding:12px;margin:15px 0;background:#0f1724;color:#fff;border:1px solid #4da3ff;border-radius:8px">
    
    <div style="display:flex;gap:10px;margin-top:20px">
      <button onclick="handlePasswordReset()" style="flex:1;background:#00d4aa;color:#000;font-weight:900;padding:12px;border-radius:10px;border:none;cursor:pointer">
        Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
      </button>
      <button onclick="closePasswordResetModal()" style="flex:1;background:transparent;color:var(--accent);border:2px solid var(--accent);padding:12px;border-radius:10px;cursor:pointer;font-weight:700">
        Ø¥Ù„ØºØ§Ø¡
      </button>
    </div>
    
    <div style="margin-top:15px;background:rgba(255,215,0,0.1);padding:12px;border-radius:8px;border-left:4px solid #ffd700">
      <p style="margin:0;color:#ffd700;font-size:14px">âœ… Ø³ÙŠØ±Ø³Ù„ Ù„Ùƒ Firebase Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¹Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</p>
    </div>
  </div>
</div>

<!-- loading -->
<div class="loading" id="loading">
  <div class="spinner"></div>
  <p style="margin-top:10px">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ -->
<div class="success-popup" id="successPopup">
  <div class="popup-card">
    <div class="crown">ğŸ‘‘</div>
    <h2>Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„Ùƒ Ù…Ø¹ MR Store</h2>
    <p>ØªÙ… Ù†Ø³Ø® Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø·Ù„Ø¨Ùƒ ÙˆÙØªØ­ Ø§Ù„Ø¨Ø±ÙŠØ¯.</p>
    <button onclick="closePopup()">ØªÙ…</button>
  </div>
</div>

<footer class="footer">Â© 2025 MR Store</footer>

<script>
// ==================== FIREBASE CONFIGURATION ====================
// ğŸ”¥ Ø¶Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Firebase Ù‡Ù†Ø§ (Ù…Ù† Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©)
const firebaseConfig = {
  apiKey: "AIzaSyCOaYXdUcSXdYnbaeWxQajxYFxqBvZJV54",
  authDomain: "mr-store-b18a3.firebaseapp.com",
  projectId: "mr-store-b18a3",
  storageBucket: "mr-store-b18a3.firebasestorage.app",
  messagingSenderId: "964415721116",
  appId: "1:964415721116:web:9d7e8df7af69d76974a759"
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// ==================== DATA ====================
const DATA = {
  games:{
    pubg:[{name:"30 Ø´Ø¯Ø©",price:0.40},{name:"60 Ø´Ø¯Ø©",price:0.70},{name:"300+25 Ø´Ø¯Ø©",price:3.25},{name:"600+60 Ø´Ø¯Ø©",price:6.35},{name:"1500+300 Ø´Ø¯Ø©",price:15.70}],
    freefire:[{name:"110 Ø¬ÙˆØ§Ù‡Ø±",price:0.75},{name:"231 Ø¬ÙˆÙ‡Ø±Ø©",price:1.45},{name:"583 Ø¬ÙˆÙ‡Ø±Ø©",price:3.50},{name:"1188 Ø¬ÙˆÙ‡Ø±Ø©",price:6.90},{name:"2420 Ø¬ÙˆÙ‡Ø±Ø©",price:13.80}],
    deltaforce:[{name:"19 Ø°Ù‡Ø¨Ø©",price:0.30},{name:"32 Ø°Ù‡Ø¨Ø©",price:0.45},{name:"63 Ø°Ù‡Ø¨Ø©",price:0.80},{name:"336 Ø°Ù‡Ø¨Ø©",price:4.00},{name:"482 Ø°Ù‡Ø¨Ø©",price:5.50},{name:"785 Ø°Ù‡Ø¨Ø©",price:7.40}],
    roblox:[{name:"$10",price:7.60},{name:"$20",price:14.60},{name:"$25",price:18.00},{name:"$40",price:28.60},{name:"$50",price:35.65},{name:"$100",price:71.00}],
    newstate:[{name:"300 NC",price:1.00},{name:"1500+80 NC",price:3.80},{name:"3600+250 NC",price:8.90},{name:"9300+930 NC",price:22.50}]
  },
  psn:{
    usa:[{name:"$10",price:7.20},{name:"$25",price:17.85},{name:"$50",price:32.80},{name:"$55",price:39.50},{name:"$75",price:53.50}],
    sa:[{name:"$10",price:8.25},{name:"$20",price:15.20},{name:"$40",price:30.40},{name:"$50",price:37.75},{name:"$70",price:52.35}]
  }
};

// ==================== GLOBAL VARIABLES ====================
let currentUser = null;
let lastOrderData = null;
let firebaseUserData = null;

// ==================== ELEMENTS ====================
const paymentSection = document.getElementById('paymentSection');
const productsSection = document.getElementById('productsSection');
const gamesSection = document.getElementById('gamesSection');
const psnSection = document.getElementById('psnSection');
const cardsSection = document.getElementById('cardsSection');
const gameAmount = document.getElementById('gameAmount');
const psnAmount = document.getElementById('psnAmount');
const gameTotalEl = document.getElementById('gameTotal');
const psnTotalEl = document.getElementById('psnTotal');
const detailsSection = document.getElementById('detailsSection');
const gameDiscountBtn = document.getElementById('gameDiscountBtn');
const psnDiscountBtn = document.getElementById('psnDiscountBtn');
const repeatLastBtn = document.getElementById('repeatLastBtn');
const quickHistory = document.getElementById('quickHistory');
const quickHistoryList = document.getElementById('quickHistoryList');
const loading = document.getElementById('loading');
const profileImageInput = document.getElementById('profileImageInput');

// ==================== FIREBASE AUTH FUNCTIONS ====================
async function signUpWithFirebase(email, password, username, instagram) {
  try {
    showLoading(true);
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    const user = userCredential.user;
    
    // Save user data to Firestore
    await db.collection('users').doc(user.uid).set({
      username: username,
      instagram: instagram || '',
      email: email,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      profileImage: '',
      orders: []
    });
    
    showLoading(false);
    return { success: true, user: user };
  } catch (error) {
    showLoading(false);
    return { success: false, error: error.message };
  }
}

async function loginWithFirebase(email, password) {
  try {
    showLoading(true);
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    showLoading(false);
    return { success: true, user: userCredential.user };
  } catch (error) {
    showLoading(false);
    return { success: false, error: error.message };
  }
}

async function resetPasswordFirebase(email) {
  try {
    showLoading(true);
    await auth.sendPasswordResetEmail(email);
    showLoading(false);
    return { success: true, message: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ' };
  } catch (error) {
    showLoading(false);
    return { success: false, error: error.message };
  }
}

async function changePasswordFirebase(newPassword) {
  try {
    showLoading(true);
    const user = auth.currentUser;
    await user.updatePassword(newPassword);
    showLoading(false);
    return { success: true, message: 'ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­' };
  } catch (error) {
    showLoading(false);
    return { success: false, error: error.message };
  }
}

async function getUserDataFromFirestore(userId) {
  try {
    const doc = await db.collection('users').doc(userId).get();
    if (doc.exists) {
      return { success: true, data: doc.data() };
    } else {
      return { success: false, error: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' };
    }
  } catch (error) {
    return { success: false, error: error.message };
  }
}

async function updateUserProfileInFirestore(userId, data) {
  try {
    await db.collection('users').doc(userId).update(data);
    return { success: true };
  } catch (error) {
    return { success: false, error: error.message };
  }
}

async function saveOrderToFirestore(userId, orderData) {
  try {
    const orderRef = await db.collection('users').doc(userId).collection('orders').add({
      ...orderData,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      status: 'pending'
    });
    
    return { success: true, orderId: orderRef.id };
  } catch (error) {
    return { success: false, error: error.message };
  }
}

async function getUserOrdersFromFirestore(userId) {
  try {
    const snapshot = await db.collection('users').doc(userId).collection('orders')
      .orderBy('createdAt', 'desc')
      .limit(10)
      .get();
    
    const orders = [];
    snapshot.forEach(doc => {
      orders.push({ id: doc.id, ...doc.data() });
    });
    
    return { success: true, orders: orders };
  } catch (error) {
    return { success: false, error: error.message };
  }
}

async function uploadProfileImageToStorage(userId, file) {
  try {
    const storageRef = storage.ref(`profile_images/${userId}/${Date.now()}_${file.name}`);
    const snapshot = await storageRef.put(file);
    const downloadURL = await snapshot.ref.getDownloadURL();
    
    await updateUserProfileInFirestore(userId, { profileImage: downloadURL });
    
    return { success: true, imageUrl: downloadURL };
  } catch (error) {
    return { success: false, error: error.message };
  }
}

async function deleteProfileImageFromStorage(userId, imageUrl) {
  try {
    const imageRef = storage.refFromURL(imageUrl);
    await imageRef.delete();
    
    await updateUserProfileInFirestore(userId, { profileImage: '' });
    
    return { success: true };
  } catch (error) {
    return { success: false, error: error.message };
  }
}

// ==================== AUTH STATE LISTENER ====================
auth.onAuthStateChanged(async (user) => {
  if (user) {
    // User is signed in
    const userData = await getUserDataFromFirestore(user.uid);
    if (userData.success) {
      firebaseUserData = userData.data;
      setCurrentUser({
        uid: user.uid,
        email: user.email,
        ...userData.data
      });
      updateQuickHistory();
    }
  } else {
    // User is signed out
    firebaseUserData = null;
    document.getElementById('headerAuthBtn').style.display = 'inline-block';
    document.getElementById('headerUserMenu').style.display = 'none';
    quickHistory.style.display = 'none';
  }
});

// ==================== INITIALIZATION ====================
function init() {
  // ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ØŒ onAuthStateChanged Ø³ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  resetDiscountButton('game');
  resetDiscountButton('psn');
  showProducts();
  loadLastOrder();
  
  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ø¯Ø« ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±
  if (profileImageInput) {
    profileImageInput.addEventListener('change', handleProfileImageUpload);
  }
}

// ==================== SHOW SECTIONS ====================
function showPayment(){
  setActiveNav('navPayment');
  productsSection.style.display='none';
  cardsSection.style.display='none';
  paymentSection.style.display='block';
  window.scrollTo({top:0,behavior:'smooth'});
}

function showProducts(){
  setActiveNav('navProducts');
  paymentSection.style.display='none';
  cardsSection.style.display='none';
  productsSection.style.display='block';
  window.scrollTo({top:0,behavior:'smooth'});
  updateQuickHistory();
}

function showCards(){
  setActiveNav('navCards');
  productsSection.style.display='none';
  paymentSection.style.display='none';
  cardsSection.style.display='block';
  window.scrollTo({top:0,behavior:'smooth'});
}

function setActiveNav(navId){
  document.querySelectorAll('nav a').forEach(a=>a.classList.remove('active'));
  document.getElementById(navId).classList.add('active');
}

// ==================== CATEGORY ====================
function updateCategory(){
  const c=document.getElementById('category').value;
  gamesSection.style.display=(c==='games')?'block':'none';
  psnSection.style.display=(c==='psn')?'block':'none';
  detailsSection.style.display='none';
  repeatLastBtn.style.display='none';
  gameAmount.innerHTML='';
  psnAmount.innerHTML='';
  gameTotalEl.textContent='Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0.00 Ø¯.Ø£';
  psnTotalEl.textContent='Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0.00 Ø¯.Ø£';
  resetDiscountButton('game');
  resetDiscountButton('psn');
}

// ==================== GAMES LIST ====================
function updateGameOptions(){
  const g=document.getElementById('game').value;
  gameAmount.innerHTML='';
  if(!g){document.getElementById('gameAmountSection').style.display='none';return;}
  DATA.games[g].forEach(item=>{
    const o=document.createElement('option');
    o.value=`${item.name} - ${item.price.toFixed(2)}`;
    o.dataset.basePrice=item.price;
    o.dataset.price=item.price;
    o.textContent=`${item.name} - ${item.price.toFixed(2)} Ø¯.Ø£`;
    gameAmount.appendChild(o);
  });
  document.getElementById('gameAmountSection').style.display='block';
  calculateTotal('game');
}

// ==================== PSN LIST ====================
function updatePSNOptions(){
  const p=document.getElementById('psnType').value;
  psnAmount.innerHTML='';
  if(!p){document.getElementById('psnAmountSection').style.display='none';return;}
  DATA.psn[p].forEach(item=>{
    const o=document.createElement('option');
    o.value=`${item.name} - ${item.price.toFixed(2)}`;
    o.dataset.basePrice=item.price;
    o.dataset.price=item.price;
    o.textContent=`${item.name} - ${item.price.toFixed(2)} Ø¯.Ø£`;
    psnAmount.appendChild(o);
  });
  document.getElementById('psnAmountSection').style.display='block';
  calculateTotal('psn');
}

// ==================== SELECTION LIMIT ====================
function handleSelectionLimit(section){
  const el=(section==='game')?gameAmount:psnAmount;
  const selected=[...el.selectedOptions];
  if(selected.length>3){
    showAlert('Ù…Ø³Ù…ÙˆØ­ Ø§Ø®ØªÙŠØ§Ø± 3 Ø¨Ø§Ù‚Ø§Øª ÙÙ‚Ø·','error');
    selected[selected.length-1].selected=false;
    return;
  }
  detailsSection.style.display=(selected.length>0)?'block':'none';
  calculateTotal(section);
}

// ==================== CALCULATE TOTAL ====================
function calculateTotal(section){
  let total=0;
  if(section==='game'){
    [...gameAmount.selectedOptions].forEach(o=>{total+=parseFloat(o.dataset.price||0);});
    gameTotalEl.textContent=`Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toFixed(2)} Ø¯.Ø£`;
  }else{
    [...psnAmount.selectedOptions].forEach(o=>{total+=parseFloat(o.dataset.price||0);});
    psnTotalEl.textContent=`Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toFixed(2)} Ø¯.Ø£`;
  }
}

// ==================== DISCOUNT FUNCTIONS ====================
function resetDiscountButton(type){
  const btn=(type==='game')?gameDiscountBtn:psnDiscountBtn;
  const key=(type==='game')?'discount_used_games':'discount_used_psn';
  const last=localStorage.getItem(key);
  if(last && (Date.now()-parseInt(last))<7200000){
    btn.classList.add('used');
    btn.disabled=true;
    btn.textContent='âœ” ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®ØµÙ…';
  }else{
    btn.classList.remove('used');
    btn.disabled=false;
    btn.textContent='ğŸ’° ØªÙØ¹ÙŠÙ„ Ø®ØµÙ… 1.5%';
  }
}

function applyDiscount(type){
  const key=(type==='game')?'discount_used_games':'discount_used_psn';
  const btn=(type==='game')?gameDiscountBtn:psnDiscountBtn;
  const last=localStorage.getItem(key);
  const now=Date.now();

  if(last && (now-parseInt(last))<7200000){
    const remaining=Math.ceil((7200000-(now-parseInt(last)))/60000);
    showAlert(`Ø§Ù„Ø®ØµÙ… Ù…Ø±Ø© ÙƒÙ„ Ø³Ø§Ø¹ØªÙŠÙ†. ØªØ¨Ù‚Ù‰ ${remaining} Ø¯Ù‚ÙŠÙ‚Ø©`,'warning');
    return;
  }

  const el=(type==='game')?gameAmount:psnAmount;
  [...el.options].forEach(op=>{
    const base=parseFloat(op.dataset.basePrice);
    const discounted=parseFloat((base*0.985).toFixed(2));
    op.dataset.price=discounted;
    const name=op.value.split('-')[0].trim();
    op.textContent=`${name} - ${discounted.toFixed(2)} Ø¯.Ø£`;
    op.value=`${name} - ${discounted.toFixed(2)}`;
  });

  localStorage.setItem(key,now);
  btn.classList.add('used');
  btn.disabled=true;
  btn.textContent='âœ” ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®ØµÙ…';
  calculateTotal(type);
  showAlert('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®ØµÙ… Ø¨Ù†Ø¬Ø§Ø­!','success');
}

// ==================== ORDER FUNCTIONS ====================
function buildOrderBodyEncoded(){
  const cat=document.getElementById('category').value||'-';
  const arr=[];
  arr.push("ğŸ¬ Ø§Ù„Ù…ØªØ¬Ø±: MR Store");
  arr.push(`ğŸ“ Ø§Ù„Ù‚Ø³Ù…: ${cat}`);

  if(cat==='games'){
    const game=document.getElementById('game').value||'-';
    const selected=[...gameAmount.selectedOptions].map(o=>o.textContent);
    arr.push(`ğŸ® Ø§Ù„Ù„Ø¹Ø¨Ø©: ${game}`);
    arr.push(`ğŸ“¦ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª: ${selected.join(', ')||'-'}`);
  }

  if(cat==='psn'){
    const type=document.getElementById('psnType').value||'-';
    const selected=[...psnAmount.selectedOptions].map(o=>o.textContent);
    const delivery=document.getElementById('psnDelivery').value||'-';
    arr.push(`ğŸ´ Ù†ÙˆØ¹ PSN: ${type}`);
    arr.push(`ğŸ“¦ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª: ${selected.join(', ')||'-'}`);
    arr.push(`ğŸ“¨ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…: ${delivery}`);
  }

  const totalGame=[...gameAmount.selectedOptions].reduce((s,o)=>s+parseFloat(o.dataset.price||0),0);
  const totalPsn=[...psnAmount.selectedOptions].reduce((s,o)=>s+parseFloat(o.dataset.price||0),0);
  const grand=(totalGame+totalPsn).toFixed(2);

  arr.push(`ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: ${grand} Ø¯.Ø£`);
  arr.push(`ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…/ID: ${document.getElementById('username').value}`);
  arr.push(`ğŸ“± Ø¥Ù†Ø³ØªØºØ±Ø§Ù…: ${document.getElementById('insta').value}`);
  arr.push(`ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ${document.getElementById('email').value}`);
  arr.push(`ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${document.getElementById('notes').value||'-'}`);

  lastOrderData = {
    category: cat,
    game: document.getElementById('game').value,
    psnType: document.getElementById('psnType').value,
    gameItems: [...gameAmount.selectedOptions].map(o => ({text: o.textContent, price: o.dataset.price})),
    psnItems: [...psnAmount.selectedOptions].map(o => ({text: o.textContent, price: o.dataset.price})),
    psnDelivery: document.getElementById('psnDelivery').value,
    username: document.getElementById('username').value,
    insta: document.getElementById('insta').value,
    email: document.getElementById('email').value,
    notes: document.getElementById('notes').value,
    total: grand,
    timestamp: Date.now()
  };
  
  localStorage.setItem('mr_last_order', JSON.stringify(lastOrderData));

  return encodeURIComponent(arr.join("\n"));
}

async function sendOrder(){
  showLoading(true);
  
  try {
    const cat=document.getElementById('category').value;
    if(!cat){showAlert('Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…','error'); showLoading(false); return;}

    if(cat==='games' && gameAmount.selectedOptions.length===0){showAlert('Ø§Ø®ØªØ± Ø¨Ø§Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„','error'); showLoading(false); return;}
    if(cat==='psn' && psnAmount.selectedOptions.length===0){showAlert('Ø§Ø®ØªØ± Ø¨Ø§Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„','error'); showLoading(false); return;}

    const username=document.getElementById('username').value.trim();
    const insta=document.getElementById('insta').value.trim();
    const email=document.getElementById('email').value.trim();

    if(!username || !insta || !email){showAlert("Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø§Ù†Ø§Øª",'error'); showLoading(false); return;}

    const bodyEnc=buildOrderBodyEncoded();
    const bodyPlain=decodeURIComponent(bodyEnc);

    try{await navigator.clipboard.writeText(bodyPlain);}catch(e){}

    // Save order to Firebase if user is logged in
    if (currentUser && currentUser.uid) {
      const orderData = {
        body: bodyPlain,
        category: cat,
        total: lastOrderData.total,
        username: username,
        insta: insta,
        email: email
      };
      
      await saveOrderToFirestore(currentUser.uid, orderData);
    }

    repeatLastBtn.style.display='block';
    updateQuickHistory();

    const subject=encodeURIComponent("Ø·Ù„Ø¨ Ù…Ù† MR Store");
    const to="asdm86411@gmail.com";
    const cc="elzw520@gmail.com";

    const link=`mailto:${to}?cc=${cc}&subject=${subject}&body=${bodyEnc}`;
    setTimeout(() => {
      window.open(link,"_blank");
      document.getElementById('successPopup').style.display='flex';
      showLoading(false);
    }, 500);

  } catch(error) {
    showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨','error');
    showLoading(false);
  }
}

// ==================== REPEAT LAST ORDER ====================
function repeatLastOrder(){
  if(!lastOrderData) {
    loadLastOrder();
    if(!lastOrderData) {
      showAlert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ø³Ø§Ø¨Ù‚','info');
      return;
    }
  }
  
  document.getElementById('category').value = lastOrderData.category || '';
  updateCategory();
  
  if(lastOrderData.category === 'games') {
    setTimeout(() => {
      document.getElementById('game').value = lastOrderData.game || '';
      updateGameOptions();
      
      setTimeout(() => {
        const items = lastOrderData.gameItems || [];
        for(let i = 0; i < gameAmount.options.length; i++) {
          const option = gameAmount.options[i];
          const itemText = option.textContent;
          const wasSelected = items.some(item => item.text === itemText);
          option.selected = wasSelected;
        }
        handleSelectionLimit('game');
        calculateTotal('game');
      }, 100);
    }, 100);
  }
  
  if(lastOrderData.category === 'psn') {
    setTimeout(() => {
      document.getElementById('psnType').value = lastOrderData.psnType || '';
      updatePSNOptions();
      
      setTimeout(() => {
        const items = lastOrderData.psnItems || [];
        for(let i = 0; i < psnAmount.options.length; i++) {
          const option = psnAmount.options[i];
          const itemText = option.textContent;
          const wasSelected = items.some(item => item.text === itemText);
          option.selected = wasSelected;
        }
        document.getElementById('psnDelivery').value = lastOrderData.psnDelivery || 'direct';
        handleSelectionLimit('psn');
        calculateTotal('psn');
      }, 100);
    }, 100);
  }
  
  document.getElementById('username').value = lastOrderData.username || '';
  document.getElementById('insta').value = lastOrderData.insta || '';
  document.getElementById('email').value = lastOrderData.email || '';
  document.getElementById('notes').value = lastOrderData.notes || '';
  
  showAlert('ØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ø®Ø± Ø·Ù„Ø¨ÙŠØ©','success');
}

function loadLastOrder(){
  try {
    const saved = localStorage.getItem('mr_last_order');
    if(saved) {
      lastOrderData = JSON.parse(saved);
    }
  } catch(e) {
    console.error('Error loading last order:', e);
  }
}

// ==================== QUICK HISTORY ====================
async function updateQuickHistory(){
  if(!currentUser || !currentUser.uid) {
    quickHistory.style.display = 'none';
    return;
  }
  
  try {
    const result = await getUserOrdersFromFirestore(currentUser.uid);
    
    if(!result.success || !result.orders || result.orders.length === 0) {
      quickHistory.style.display = 'none';
      return;
    }
  
    const orders = result.orders.slice(0, 3); // Ø¢Ø®Ø± 3 Ø·Ù„Ø¨Ø§Øª
    quickHistoryList.innerHTML = '';
    
    orders.forEach((order) => {
      const div = document.createElement('div');
      div.className = 'history-item';
      
      const lines = order.body ? order.body.split('\n') : [];
      const category = lines.find(l => l && l.includes('Ø§Ù„Ù‚Ø³Ù…:'))?.replace('Ø§Ù„Ù‚Ø³Ù…:', '').trim() || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
      const total = order.total || '0.00 Ø¯.Ø£';
      const date = order.createdAt ? new Date(order.createdAt.toDate()).toLocaleDateString('ar-SA') : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
      
      div.innerHTML = `
        <div class="history-details">
          <div style="font-weight:700;color:var(--accent)">${category}</div>
          <div style="font-size:14px;color:var(--muted)">${date}</div>
          <div style="color:#ffd700;font-weight:700">${total}</div>
        </div>
        <button class="repeat-order-btn" onclick="fillOrderFromHistory('${order.id}')">
          ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø©
        </button>
      `;
      
      quickHistoryList.appendChild(div);
    });
    
    quickHistory.style.display = 'block';
  } catch(error) {
    console.error('Error updating quick history:', error);
    quickHistory.style.display = 'none';
  }
}

async function fillOrderFromHistory(orderId){
  if(!currentUser || !currentUser.uid) return;
  
  try {
    const doc = await db.collection('users').doc(currentUser.uid).collection('orders').doc(orderId).get();
    if(!doc.exists) return;
    
    const order = doc.data();
    const lines = order.body.split('\n');
    
    const categoryLine = lines.find(l => l.includes('Ø§Ù„Ù‚Ø³Ù…:'));
    const userLine = lines.find(l => l.includes('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…/ID:'));
    const instaLine = lines.find(l => l.includes('Ø¥Ù†Ø³ØªØºØ±Ø§Ù…:'));
    const emailLine = lines.find(l => l.includes('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:'));
    const notesLine = lines.find(l => l.includes('Ù…Ù„Ø§Ø­Ø¸Ø§Øª:'));
    
    if(categoryLine) {
      const category = categoryLine.split(':')[1]?.trim().toLowerCase();
      document.getElementById('category').value = category || '';
      updateCategory();
    }
    
    if(userLine) document.getElementById('username').value = userLine.split(':')[1]?.trim() || '';
    if(instaLine) document.getElementById('insta').value = instaLine.split(':')[1]?.trim() || '';
    if(emailLine) document.getElementById('email').value = emailLine.split(':')[1]?.trim() || '';
    if(notesLine && notesLine.includes('Ù…Ù„Ø§Ø­Ø¸Ø§Øª:')) {
      document.getElementById('notes').value = notesLine.split(':')[1]?.trim() || '';
    }
    
    closeProfile();
    showAlert('ØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø±Ø© Ø£Ø®Ø±Ù‰','success');
  } catch(e) {
    showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨','error');
  }
}

// ==================== UTILITY FUNCTIONS ====================
function copyAlias(){
  const alias=document.getElementById('aliasName').textContent.trim();
  navigator.clipboard.writeText(alias).then(()=>showAlert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø§Ø³Ù…",'success')).catch(()=>showAlert("ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®",'error'));
}

function closePopup(){
  document.getElementById('successPopup').style.display='none';
}

function showLoading(show){
  loading.style.display = show ? 'block' : 'none';
}

// ==================== PROFILE IMAGE HANDLING ====================
async function handleProfileImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (file.size > 2 * 1024 * 1024) {
    showAlert('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 2MB', 'error');
    return;
  }
  
  if (!file.type.match('image.*')) {
    showAlert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØµÙˆØ±Ø© ÙÙ‚Ø·', 'error');
    return;
  }
  
  if (!currentUser || !currentUser.uid) {
    showAlert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
    return;
  }
  
  showLoading(true);
  const result = await uploadProfileImageToStorage(currentUser.uid, file);
  showLoading(false);
  
  if (result.success) {
    updateProfileImages(result.imageUrl);
    showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ', 'success');
  } else {
    showAlert(result.error, 'error');
  }
}

function updateProfileImages(imageData) {
  // ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ù‡ÙŠØ¯Ø±
  const headerAvatar = document.getElementById('headerUserAvatar');
  const headerFallback = document.getElementById('headerUserAvatarFallback');
  
  if (imageData) {
    headerAvatar.src = imageData;
    headerAvatar.style.display = 'block';
    if (headerFallback) headerFallback.style.display = 'none';
  } else {
    if (headerAvatar) headerAvatar.style.display = 'none';
    if (headerFallback) headerFallback.style.display = 'flex';
  }
  
  // ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
  const profileAvatarLarge = document.getElementById('profileAvatarLarge');
  const profileAvatarFallback = document.getElementById('profileAvatarFallback');
  
  if (imageData) {
    profileAvatarLarge.src = imageData;
    profileAvatarLarge.style.display = 'block';
    if (profileAvatarFallback) profileAvatarFallback.style.display = 'none';
  } else {
    if (profileAvatarLarge) profileAvatarLarge.style.display = 'none';
    if (profileAvatarFallback) profileAvatarFallback.style.display = 'flex';
  }
}

async function removeProfileImage() {
  if (!currentUser || !currentUser.uid || !firebaseUserData || !firebaseUserData.profileImage) {
    return;
  }
  
  showLoading(true);
  const result = await deleteProfileImageFromStorage(currentUser.uid, firebaseUserData.profileImage);
  showLoading(false);
  
  if (result.success) {
    updateProfileImages(null);
    showAlert('ØªÙ… Ø­Ø°Ù ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ', 'success');
  } else {
    showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©', 'error');
  }
}

function loadProfileImage() {
  if (firebaseUserData && firebaseUserData.profileImage) {
    updateProfileImages(firebaseUserData.profileImage);
  } else {
    updateProfileImages(null);
  }
}

// ==================== AUTHENTICATION UI ====================
function openAuth(){
  if(currentUser){
    toggleHeaderDropdown();
    return;
  }
  
  const backdrop = document.createElement('div');
  backdrop.className='modal-backdrop';
  backdrop.id='authBackdrop';
  
  const modal = document.createElement('div');
  modal.className='modal';
  modal.innerHTML = `
    <h3 style="text-align: center;">ğŸ‘¤ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h3>
    <div id="authForms">
      <div id="signInForm">
        <div class="form-row"><input id="loginEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" /></div>
        <div class="form-row"><input id="loginPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" /></div>
        <div style="display:flex;gap:8px; margin-top: 20px;">
          <button onclick="doLogin()" style="flex:1; background: var(--accent); color: #000; font-weight: 900;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
          <button onclick="showSignUp()" style="flex:1; background:#ffd700; color:#000; font-weight: 900;">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        </div>
        <div style="text-align: center; margin-top: 15px;">
          <button onclick="openPasswordResetModal()" style="background: transparent; color: #ffd700; border: none; cursor: pointer; font-size: 14px; text-decoration: underline;">
            ğŸ”“ Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ
          </button>
        </div>
        <div class="small-note" style="text-align: center; margin-top: 10px;">
          Ø³ØªØ¨Ù‚Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ø³Ø­Ø§Ø¨Ø© Firebase Ø§Ù„Ø¢Ù…Ù†Ø©
        </div>
      </div>
      <div id="signUpForm" style="display:none">
        <div class="form-row"><input id="regUser" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" /></div>
        <div class="form-row"><input id="regInsta" placeholder="@Instagram (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" /></div>
        <div class="form-row"><input id="regEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" /></div>
        <div class="form-row"><input id="regPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)" /></div>
        <div class="form-row"><input id="regPassConfirm" type="password" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" /></div>
        <div style="display:flex;gap:8px; margin-top: 20px;">
          <button onclick="doSignUp()" style="flex:1; background: #00d4aa; color: #000; font-weight: 900;">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
          <button onclick="showSignIn()" style="flex:1; background:#ffd700; color:#000; font-weight: 900;">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ</button>
        </div>
        <div class="small-note" style="text-align: center; margin-top: 10px;">
          Ø³ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ø£Ù…Ø§Ù† ÙÙŠ Ø³Ø­Ø§Ø¨Ø© Google
        </div>
      </div>
    </div>
    <div style="text-align:center; margin-top:15px">
      <button onclick="closeAuth()" style="background:transparent;color:var(--muted);border:none;cursor:pointer;font-size:14px">
        Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
      </button>
    </div>
  `;
  
  backdrop.appendChild(modal);
  document.body.appendChild(backdrop);
  backdrop.style.display='flex';
  
  backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) closeAuth(); });
}

function closeAuth(){
  const b=document.getElementById('authBackdrop');
  if(b) b.remove();
}

function showSignUp(){
  document.getElementById('signInForm').style.display='none';
  document.getElementById('signUpForm').style.display='block';
}

function showSignIn(){
  document.getElementById('signInForm').style.display='block';
  document.getElementById('signUpForm').style.display='none';
}

async function doSignUp(){
  const name=document.getElementById('regUser').value.trim();
  const insta=document.getElementById('regInsta').value.trim();
  const email=document.getElementById('regEmail').value.trim().toLowerCase();
  const pass=document.getElementById('regPass').value;
  const passConfirm=document.getElementById('regPassConfirm').value;

  if(!name||!email||!pass){ showAlert('Ø§Ù…Ù„Ø£ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±','error'); return; }
  if(pass.length < 6){ showAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„','error'); return; }
  if(pass !== passConfirm){ showAlert('ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©','error'); return; }

  const result = await signUpWithFirebase(email, pass, name, insta);
  
  if(result.success) {
    showAlert('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    closeAuth();
  } else {
    showAlert(result.error, 'error');
  }
}

async function doLogin(){
  const email=document.getElementById('loginEmail').value.trim().toLowerCase();
  const pass=document.getElementById('loginPass').value;
  
  if(!email||!pass){ showAlert('Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±','error'); return; }
  
  const result = await loginWithFirebase(email, pass);
  
  if(result.success) {
    showAlert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­','success');
    closeAuth();
  } else {
    showAlert(result.error, 'error');
  }
}

async function logout(){
  try {
    await auth.signOut();
    currentUser = null;
    firebaseUserData = null;
    showAlert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬','success');
  } catch(error) {
    showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', 'error');
  }
}

function setCurrentUser(userData){
  currentUser = userData;
  firebaseUserData = userData;
  document.getElementById('headerAuthBtn').style.display='none';
  document.getElementById('headerUserMenu').style.display='flex';
  const firstLetter = (userData.username||'U').trim().slice(0,1).toUpperCase();
  document.getElementById('headerUserAvatarFallback').textContent = firstLetter;
  document.getElementById('headerUserName').textContent = userData.username || userData.email;
  
  // Load profile image
  loadProfileImage();
}

function toggleHeaderDropdown(){
  const dropdown = document.getElementById('headerDropdown');
  dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
}

// ==================== PASSWORD RECOVERY ====================
function openPasswordResetModal() {
  closeAuth();
  document.getElementById('passwordResetModal').style.display = 'flex';
}

function closePasswordResetModal() {
  document.getElementById('passwordResetModal').style.display = 'none';
}

async function handlePasswordReset() {
  const email = document.getElementById('forgotEmail').value.trim();
  
  if (!email) {
    showAlert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'error');
    return;
  }
  
  const result = await resetPasswordFirebase(email);
  
  if (result.success) {
    showAlert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙˆØ§Ø±Ø¯ Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ.', 'success');
    closePasswordResetModal();
  } else {
    showAlert(result.error, 'error');
  }
}

// ==================== PASSWORD CHANGE ====================
function openChangePassword(){
  const backdrop = document.createElement('div');
  backdrop.className='modal-backdrop';
  backdrop.id='passwordBackdrop';
  
  const modal = document.createElement('div');
  modal.className='modal';
  modal.style.maxWidth = '420px';
  
  modal.innerHTML = `
    <h3 style="color: #00ffcc; margin-bottom: 20px; text-align: center;">ğŸ” ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
    
    <div class="form-row">
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</label>
      <input type="password" id="currentPassword" 
             placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©" 
             style="margin-top: 5px;">
    </div>
    
    <div class="form-row">
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label>
      <input type="password" id="newPassword" 
             placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)" 
             style="margin-top: 5px;">
    </div>
    
    <div class="form-row">
      <label>ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label>
      <input type="password" id="confirmPassword" 
             placeholder="Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" 
             style="margin-top: 5px;">
    </div>
    
    <div style="background: rgba(0, 212, 170, 0.1); 
          padding: 10px; border-radius: 8px; margin: 10px 0; color: #99a3b3; font-size: 14px;">
      <div style="margin-bottom: 5px;"><strong>Ù…ØªØ·Ù„Ø¨Ø§Øª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</strong></div>
      <div>â€¢ 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</div>
      <div>â€¢ Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… ÙƒÙ„Ù…Ø§Øª Ù…Ø±ÙˆØ± Ø³Ù‡Ù„Ø© Ù…Ø«Ù„ 123456</div>
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 15px;">
      <button onclick="saveNewPassword()" 
              style="flex: 1; background: #00d4aa; color: black; font-weight: 900; padding: 12px; border-radius: 10px; border: none; cursor: pointer;">
        Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
      </button>
      <button onclick="closeChangePassword()" 
              style="flex: 1; background: transparent; color: var(--accent); border: 2px solid var(--accent); padding: 12px; border-radius: 10px; cursor: pointer; font-weight: 700;">
        Ø¥Ù„ØºØ§Ø¡
      </button>
    </div>
    
    <div style="margin-top: 15px; text-align: center;">
      <button onclick="openPasswordResetModal()" 
              style="background: transparent; color: #ffd700; border: none; 
                     cursor: pointer; font-size: 14px; text-decoration: underline;">
        Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ
      </button>
    </div>
  `;
  
  backdrop.appendChild(modal);
  document.body.appendChild(backdrop);
  backdrop.style.display='flex';
  
  backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) closeChangePassword(); });
}

function closeChangePassword(){
  const backdrop=document.getElementById('passwordBackdrop');
  if(backdrop) {
    backdrop.style.opacity = '0';
    backdrop.style.transition = 'opacity 0.3s';
    setTimeout(() => {
      if (backdrop.parentNode) {
        backdrop.remove();
      }
    }, 300);
  }
}

async function saveNewPassword(){
  const currentPass = document.getElementById('currentPassword').value;
  const newPass = document.getElementById('newPassword').value;
  const confirmPass = document.getElementById('confirmPassword').value;
  
  if(!currentPass || !newPass || !confirmPass){
    showAlert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„','error');
    return;
  }
  
  if(newPass.length < 6){
    showAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„','error');
    return;
  }
  
  if(newPass !== confirmPass){
    showAlert('ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©','error');
    return;
  }
  
  if(newPass === currentPass){
    showAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø®ØªÙ„ÙØ© Ø¹Ù† Ø§Ù„Ø­Ø§Ù„ÙŠØ©','error');
    return;
  }
  
  // Re-authenticate user first
  const user = auth.currentUser;
  const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPass);
  
  try {
    showLoading(true);
    await user.reauthenticateWithCredential(credential);
    
    // Now change password
    const result = await changePasswordFirebase(newPass);
    showLoading(false);
    
    if (result.success) {
      showAlert('ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­','success');
      setTimeout(() => closeChangePassword(), 1500);
    } else {
      showAlert(result.error, 'error');
    }
  } catch(error) {
    showLoading(false);
    showAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
  }
}

// ==================== PROFILE SYSTEM ====================
function openProfile(){
  document.getElementById('headerDropdown').style.display='none';
  buildProfilePanel();
  document.getElementById('profilePanel').style.display='block';
}

function closeProfile(){
  document.getElementById('profilePanel').style.display='none';
}

async function buildProfilePanel(){
  if (!currentUser || !firebaseUserData) {
    showAlert('Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„','error');
    return;
  }
  
  const me = firebaseUserData;
  const firstLetter = (me.username||'U').slice(0,1).toUpperCase();
  
  loadProfileImage();
  
  document.getElementById('profileAvatarFallback').textContent = firstLetter;
  document.getElementById('profileName').textContent = me.username || 'Ù…Ø³ØªØ®Ø¯Ù…';
  document.getElementById('profileInsta').textContent = me.instagram || '-';
  document.getElementById('profileEmail').textContent = me.email || '-';
  
  const joinDate = me.createdAt ? new Date(me.createdAt.toDate()).toLocaleDateString('ar-SA') : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
  document.getElementById('profileMemberSince').textContent = `Ø¹Ø¶Ùˆ Ù…Ù†Ø°: ${joinDate}`;
  
  document.getElementById('editName').value = me.username || '';
  document.getElementById('editInsta').value = me.instagram || '';
  
  // Load orders from Firebase
  const ordersList = document.getElementById('ordersList');
  ordersList.innerHTML = '<p style="color:var(--muted)">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>';
  
  try {
    const result = await getUserOrdersFromFirestore(currentUser.uid);
    
    if(!result.success || !result.orders || result.orders.length === 0){
      ordersList.innerHTML = '<p style="color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</p>';
    } else {
      ordersList.innerHTML = '';
      result.orders.forEach((ord, idx) => {
        const div = document.createElement('div');
        div.className = 'order-item';
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:8px">
            <div style="font-weight:800">${ord.createdAt ? new Date(ord.createdAt.toDate()).toLocaleString('ar-SA') : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</div>
            <div>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <b style="color:#ffd700">${ord.total || '0.00'} Ø¯.Ø£</b></div>
          </div>
          <pre style="white-space:pre-wrap;margin-top:8px;color:#fff;background:transparent;border:none;font-family:Tajawal,sans-serif;max-height:150px;overflow:auto;padding:10px;background:#0a0f1a;border-radius:8px">${ord.body || ''}</pre>
          <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
            <button onclick="useOrderAgain('${ord.id}')" 
                    style="background:#ffd700;color:#000;padding:6px 12px;border-radius:6px;border:none;cursor:pointer;font-weight:700">
              ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨
            </button>
          </div>
        `;
        ordersList.appendChild(div);
      });
    }
  } catch(error) {
    ordersList.innerHTML = '<p style="color:var(--error)">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>';
  }
}

async function useOrderAgain(orderId){
  if(!currentUser || !currentUser.uid) return;
  
  try {
    const doc = await db.collection('users').doc(currentUser.uid).collection('orders').doc(orderId).get();
    if(!doc.exists) return;
    
    const order = doc.data();
    const lines = order.body.split('\n');
    
    const categoryLine = lines.find(l => l.includes('Ø§Ù„Ù‚Ø³Ù…:'));
    const userLine = lines.find(l => l.includes('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…/ID:'));
    const instaLine = lines.find(l => l.includes('Ø¥Ù†Ø³ØªØºØ±Ø§Ù…:'));
    const emailLine = lines.find(l => l.includes('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:'));
    const notesLine = lines.find(l => l.includes('Ù…Ù„Ø§Ø­Ø¸Ø§Øª:'));
    
    if(categoryLine) {
      const category = categoryLine.split(':')[1]?.trim().toLowerCase();
      document.getElementById('category').value = category || '';
      updateCategory();
    }
    
    if(userLine) document.getElementById('username').value = userLine.split(':')[1]?.trim() || '';
    if(instaLine) document.getElementById('insta').value = instaLine.split(':')[1]?.trim() || '';
    if(emailLine) document.getElementById('email').value = emailLine.split(':')[1]?.trim() || '';
    if(notesLine && notesLine.includes('Ù…Ù„Ø§Ø­Ø¸Ø§Øª:')) {
      document.getElementById('notes').value = notesLine.split(':')[1]?.trim() || '';
    }
    
    closeProfile();
    showAlert('ØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø±Ø© Ø£Ø®Ø±Ù‰','success');
  } catch(e) {
    showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨','error');
  }
}

async function saveProfile(){
  const name = document.getElementById('editName').value.trim();
  const insta = document.getElementById('editInsta').value.trim();
  
  if(!name){ showAlert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…','error'); return; }
  
  if(!currentUser || !currentUser.uid){ showAlert('Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„','error'); return; }
  
  showLoading(true);
  const result = await updateUserProfileInFirestore(currentUser.uid, {
    username: name,
    instagram: insta || ''
  });
  showLoading(false);
  
  if(result.success) {
    // Update local data
    firebaseUserData.username = name;
    firebaseUserData.instagram = insta || '';
    setCurrentUser({
      uid: currentUser.uid,
      email: currentUser.email,
      ...firebaseUserData
    });
    showAlert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù','success');
    buildProfilePanel();
  } else {
    showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª', 'error');
  }
}

// ==================== ALERT SYSTEM ====================
function showAlert(message, type = 'info', duration = 3000){
  const oldAlerts = document.querySelectorAll('.custom-alert');
  oldAlerts.forEach(alert => alert.remove());
  
  const alertDiv = document.createElement('div');
  alertDiv.className = `custom-alert alert-${type}`;
  
  const icons = {
    success: 'âœ…',
    error: 'âŒ',
    info: 'â„¹ï¸',
    warning: 'âš ï¸'
  };
  
  alertDiv.innerHTML = `
    <span style="font-size: 24px;">${icons[type] || icons.info}</span>
    <span style="flex: 1; text-align: right;">${message}</span>
    <button onclick="this.parentElement.remove()" style="background:transparent;border:none;color:inherit;font-size:18px;cursor:pointer;padding:0 0 0 10px">âœ•</button>
  `;
  
  document.body.appendChild(alertDiv);
  
  if(duration > 0){
    setTimeout(() => {
      if(alertDiv.parentNode){
        alertDiv.style.opacity = '0';
        alertDiv.style.transition = 'opacity 0.3s';
        setTimeout(() => alertDiv.remove(), 300);
      }
    }, duration);
  }
}

// ==================== TEST FIREBASE CONNECTION ====================
async function testFirebaseConnection() {
  try {
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© Ø¨Ø³ÙŠØ·Ø© Ù…Ù† Firestore
    const testDoc = await db.collection('test').doc('connection').get();
    console.log('âœ… Firebase connection successful!');
    
    // Ø§Ø®ØªØ¨Ø§Ø± Authentication
    const authState = auth.currentUser;
    console.log('âœ… Firebase Auth ready! User:', authState ? 'Logged in' : 'Not logged in');
    
    return true;
  } catch (error) {
    console.error('âŒ Firebase connection failed:', error);
    showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ÙÙŠ Firebase Console.', 'error', 5000);
    return false;
  }
}

// ==================== INITIALIZATION ====================
// ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.addEventListener('DOMContentLoaded', async () => {
  await testFirebaseConnection();
  init();
});

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
document.addEventListener('click', (e)=>{
  const headerMenu = document.getElementById('headerUserMenu');
  const headerDropdown = document.getElementById('headerDropdown');
  
  if(headerMenu && headerDropdown){
    if(!headerMenu.contains(e.target) && !headerDropdown.contains(e.target)){
      headerDropdown.style.display='none';
    }
  }
});
</script>
</body>
</html>
